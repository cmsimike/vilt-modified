from openai import OpenAI
from pydantic import BaseModel
import json
import base64
import dotenv

dotenv.load_dotenv()


usda_catories = [
    "beef",
    "chicken",
    "bread",
    "lettuce",
    "cheese",
    "pork",
    "spinach",
    "egg",
    "salad dressing",
    "yogurt",
    "rice",
    "turkey",
    "mushrooms",
    "peppers",
    "orange juice",
    "milk",
    "carrots",
    "kale",
    "onions",
    "corn",
    "cereals",
    "tomatoes",
    "peas",
    "muffins",
    "cucumber",
    "pineapple",
    "peaches",
    "broccoli",
    "cherries",
    "coffee",
    "pizza",
    "blueberries",
    "waffles",
    "strawberries",
    "fish",
    "apples",
    "pickles",
    "cauliflower",
    "radishes",
    "macaroni",
    "raspberries",
    "pastries",
    "tangerines",
    "celery",
    "peanut butter",
    "ice cream",
    "bananas",
    "quinoa",
    "chowder",
    "kiwifruit",
    "popcorn",
    "shrimp",
    "mangos",
    "watermelon",
    "croissants",
    "potatoes",
    "garlic bread",
    "sandwich",
    "burrito",
    "lasagna",
    "grits",
    "cake",
    "ravioli",
    "salmon",
    "hummus",
    "gyoza",
    "pork sandwich",
    "donuts",
    "poutine",
    "miso soup",
    "triamisu",
    "jelly",
    "deviled egg",
    "spaghetti carbonara",
    "gnocchi",
    "bruschetta",
    "chocolate mousse",
    "crab cakes",
    "samosa",
    "pad thai",
    "cheese plate",
    "beef tartare",
    "chocolate cake",
    "bibimbap",
    "asparagus",
    "pho",
    "creme brulee",
    "hot and sour soup",
    "ceviche",
    "edamame",
    "egg benedict",
    "club sandwich",
    "french onion soup",
    "calamari",
    "scallops",
    "strawberry shortcake",
    "churros",
    "chips and salsa",
    "cheesecake",
    "beet salad",
    "ramen",
    "spaghetti bolognese",
    "lobster bisque",
    "greek salad",
    "takoyaki",
    "huevos rancheros",
    "panna cotta",
    "paella",
    "beignets",
    "risotto",
    "seaweed salad",
    "cheese sandwich",
    "escargots",
    "sushi",
    "mussels",
    "cup cakes",
    "falafel",
    "baklava",
    "croque madame",
    "foie gras",
    "macarons",
    "bread pudding",
    "carrot cake",
    "lobster sandwich",
    "sashimi",
    "caprese salad",
    "oyster",
    "tuna tartare",
    "peking duck",
    "chips",
    "bologna",
    "potato salad",
    "dumplings",
    "onion rings",
    "hotdog",
    "avocados",
    "fried rice",
    "bacon",
    "arugula",
    "cookie",
    "oatmeal",
    "tacos",
    "apple pie",
    "guacamole",
    "fruit juice",
    "potato chips",
    "spaghetti",
    "ham",
    "nachos",
    "melons",
    "honeydrew melons",
    "oil",
    "salami",
    "tilapia",
    "tea",
    "pineapple juice",
    "pears",
    "steak",
    "cookies",
    "lemonade",
    "apricots",
    "french fries",
    "sauce",
    "water",
    "cranberry juice",
    "biscuits",
    "cheese quesadilla",
    "caesar salad",
    "spices",
    "grape juice",
    "fruit punch",
    "nuts",
    "egg rolls",
    "plums",
    "chicken quesadilla",
    "french dressing",
    "apple juice",
    "almonds",
    "hash brown",
    "hash browns",
    "smoothie",
    "pasta",
    "russian dressing",
    "blackberries",
    "cheeseburger",
    "cashew",
    "pancake",
    "potato",
    "smoothies",
    "cola",
    "banana",
    "honeydew melons",
    "figs",
    "oranges",
    "apricot",
    "peanuts",
    "beans",
    "juice",
    "butter",
    "energy drink",
    "cranberries",
    "soup",
    "mustard",
    "citrus fruit juice",
    "grape drink",
    "orange drink",
    "tomato juice",
    "granola bar",
    "almond milk",
    "squash",
    "candies",
    "doughnuts",
    "meatballs",
    "garlic",
    "wine",
    "hamburger",
    "lima beans",
    "bagels",
    "soda",
    "mustard greens",
    "noodles",
    "basil",
    "guavas",
    "waffle",
    "pumpkin",
    "pepper",
    "jams",
    "parsley",
    "pasta sauce",
    "chocolate milk",
    "fruit cocktail",
    "vegetable",
    "creamy dressing",
    "rolls",
    "cantaloupe melons",
    "boysenberries",
    "pop tarts",
    "tortillas",
    "bar",
    "walnuts",
    "chickpeas",
    "biscuit",
    "crackers",
    "beverages",
    "italian dressing",
    "ranch",
    "ricet",
    "gravy",
    "coconut water",
    "meat",
    "chips and guacamole",
    "tangerine juice",
    "limeade",
    "currants",
    "protein shake",
    "margarine",
    "lemon juice",
    "watercress",
    "nachos bellgrande",
    "strawberry",
    "egg noodles",
    "shake",
    "hazelnuts",
    "sausage",
    "tomato",
    "parsnips",
    "slimfast",
    "ginger",
    "vegetable juice",
    "fruit salad",
    "apricot juice",
    "taco",
    "grape",
    "eggplant",
    "salt",
    "vegetable oil",
    "vinegar",
    "dressing",
    "taco supreme",
    "pumpernickel",
    "ham spread",
    "fusion juices",
    "kielbasa",
    "plantains",
    "grape leaves",
    "pecans",
    "mayonnaise",
    "coleslaw",
    "whopper",
    "sprite",
    "spaghettios",
    "horseradish",
    "red bull",
    "carrot juice",
    "cheese spread",
    "flatbread",
    "buns",
    "mango",
    "rhubarbr",
    "turkey cheese",
    "cowpeas",
    "salad",
    "leeks",
    "macadamia nuts",
    "nachos supreme",
    "rice noodles",
    "hazelnut spread",
    "pistachio",
    "ice cream bar",
    "granola bites",
    "lime juice",
    "liverwurst spread",
    "spam",
    "granola bars",
    "chili",
    "snacks",
    "picante sauce",
    "olives",
    "shakes",
    "corn dog",
    "whiskey",
    "wafflers",
    "ginger ale",
    "beer",
    "malted drink mix",
    "chocolate",
    "pickle",
    "ovaltine",
    "turnip",
    "onion powder",
    "hamburger roll",
    "caraway seed",
    "pastry",
    "dates",
    "tamarind",
    "sunflower seeds",
    "fish fillet",
    "mozzarella sticks",
    "cracker barrel coleslaw",
    "gardenburger",
    "tuna",
    "sweet potato",
    "marinara",
    "cream puff",
    "pretzels",
    "fruit",
    "mixed fruit",
    "pomegranate juice",
    "oat bran bread",
    "puddings",
    "granola",
    "pork sausage",
    "safflower oil",
    "chicken roll",
    "chicken spread",
    "sandwich spread",
    "hot chocolate",
    "nectarines",
    "pear nectar",
    "olive loaf",
    "luna bar",
    "chilies",
    "pigeonpeas",
    "filberts",
    "pumpkin seeds",
    "pupusas",
    "pizza rolls",
    "lemonaden",
    "wieners",
    "vegetables",
    "chard",
    "cheeset",
    "beef bologna",
    "pie",
    "mulberries",
    "cereal bar",
    "okra",
    "grenadine",
    "cashew butter",
    "beets",
    "lemons",
    "gelatin desserts",
    "hot dogs",
    "tofu",
    "prune juice",
    "bacon double cheeseburger",
    "big mac",
    "chocolate bites",
    "chocolate chips",
    "acerola juice",
    "oat barn",
    "tangerine",
    "cabbage",
    "chocolate syrup",
    "peanut sauce",
    "carambola",
    "boost drink",
    "pie crust",
    "malt powder",
    "sesame seed",
    "zero ion4",
    "cheddar",
    "gatorade",
    "cream soda",
    "fruit drink",
    "hot fudge",
    "sake",
    "lobster",
    "gouda",
    "chicken noodle",
    "sesame butter",
    "catsup",
    "fig bars",
    "blackberry juice",
    "lemon",
    "tamarinds",
    "duck",
    "brotwurst",
    "soybean oil",
    "worcestershire",
    "tomato soup",
    "danish pastry",
    "persimmons",
    "wheat germ",
    "cinnamon rolls",
    "rice bran",
    "steak sauce",
    "macaroni cheese",
    "peanut spread",
    "soybeans",
    "chicken broth",
    "coleslaw dressing",
    "rice cakes",
    "taco seasoning",
    "thyme",
    "feijoa",
    "pomegranates",
    "turkey sausage",
    "cocoa",
    "minestrone soup",
    "frosted shredded wheat",
    "ralston corn flakes",
    "grain puffs",
    "double cheeseburger",
    "bacon cheeseburger",
    "seaweed",
    "prune puree",
    "ice cream cones",
    "orange sherbet",
    "cereal bars",
    "almond butter",
    "chocolate pie",
    "pine nuts",
    "cheese biscuit",
    "hush puppies",
    "sweet potatoes",
    "beef gravy",
    "wheat flour",
    "cheese sauce",
    "loaf",
    "litchis",
    "sesame sticks",
    "breakfast bars",
    "ice cream cookie sandwich",
    "chocolate malt cookies",
    "malted drink",
    "corn dogs",
    "cheese puffs",
    "salsify",
    "bean",
    "lemon-lime soda",
    "plantain chips",
    "french toaster sticks",
    "guanabana",
    "palm oil",
    "turkey lettuce",
    "cereal grain",
    "passion fruit",
    "raisins",
    "rhubarb",
    "tamale",
    "submarine sandwich",
    "sausage mcmuffin",
    "salsa verde",
    "tabasco",
    "sesame oil",
    "pillsbury crusty french dough",
    "black bean enchilada",
    "bean soup",
    "oregano",
    "creamy chicken soup",
    "sauerkraut",
    "margarine spread",
    "cheddar cheese",
    "oil teaseed",
    "nutmeg",
    "amaranth grain",
    "horchata",
    "animal cookies",
    "cinnamon graham crackers",
    "spinach souffle",
    "multigrain oats",
    "mint fudge sticks",
    "coffeecake",
    "peach nectar",
    "corn grits",
    "kashi asiago crackers",
    "cherimoya",
    "limes",
    "skittles",
    "frosted flakes",
    "parmesan cheese",
    "wheaties",
    "mcdouble",
    "seasoning mix",
    "raw",
    "steak fries",
    "waxgourd",
    "apricot kernel oil",
    "cloves",
    "almond oil",
    "soy",
    "vanilla",
    "wafers",
    "Hamburger",
    "blueberry",
    "ruffed grouse",
    "pepperoni",
    "bread chicken",
    "vegetable soup",
    "sugars",
    "mexican rice",
    "hyacinth-beans",
    "chicken nuggets",
    "pumpkin leaves",
    "candy bar",
    "tortilla chips",
    "honey",
    "crunch bar",
    "garlic powder",
    "dandelion greens",
    "sunflower seed",
    "french sticks",
    "pupusas del cerdo",
    "gin",
    "veggie chili",
    "bean beverage",
    "burger",
    "fillet",
    "soy sauce",
    "salsa",
    "dumpling soup",
    "onion soup",
    "jalapenos",
    "turnips",
    "noodle",
    "taro chips",
    "fudge sticks",
    "fruit popsicles",
    "ice cream sandwich",
    "creme sandwich",
    "guava sauce",
    "sweet cremes cookies",
    "minestrone",
    "beef broth",
    "pudding",
    "syrups",
    "oat flour",
    "taro",
    "oyster sauce",
    "tartar sauce",
    "bread turkey",
    "vodka",
    "cheese burrito",
    "chicken strips",
    "egg bagel",
    "veggie dog",
    "dulce de leche",
    "buckwheat",
    "barley",
    "fudgesicle",
    "rum",
    "garlic wings",
    "taquitos",
    "bamboo",
    "tomato powder",
    "shortening",
    "jellies",
    "oat cereal",
    "queso cotija",
    "cracker barrel",
    "nuts salad dressing",
    "flaxseed",
    "pea soup",
    "cassava",
    "chicken patty",
    "almond nougat",
    "pear",
    "ginger snaps",
    "beef celery",
    "power bar",
    "chicory",
    "seeds",
    "sunflower seed butter",
    "fried",
    "carnation breakfast essentials",
    "barn flakes",
    "nut cheerios",
    "cereals milk",
    "wafer",
    "colossal crunch",
    "cocoa mix",
    "nutri-grain fruit and nut bar",
    "sandies cookies",
    "fried pies",
    "cream",
    "oatmeal cookies",
    "golden grahams cereals",
    "oats with cinnamon bunches",
    "milky way bar",
    "whole grain",
    "chocolate-flavored drink",
    "fruit leather",
    "orangedrink",
    "grenadine syrups",
    "honey nut cheerios",
    "cheddar crackers",
    "yogurts",
    "fudge",
    "sesame crackers",
    "truffle crisp",
    "molasses",
    "bread bologna",
    "scrapple",
    "bread bacon",
    "gripz cookies",
    "butter pecan",
    "bread guava",
    "trix cereals",
    "cinnamon jacks cereals",
    "whipped cream",
    "munch bar",
    "chocolate bar",
    "poultry salad sandwich spread",
    "cheese peppers",
    "frog",
    "vegetable beef soup",
    "bockwurst",
    "pace",
    "walnut",
    "corn chips",
    "cinnamon crisp",
    "cheerios",
    "candied fruit",
    "oat bran",
    "cocoa cereals",
    "cinnamon",
    "sausage patties",
    "eggnog",
    "cakes",
    "potato puffs",
    "mung beans",
    "red taco sauce",
    "pork gravy",
    "rockfish",
    "capers",
    "canned",
    "collards",
    "chestnuts",
    "tomato beef",
    "vegetable oil-butter",
    "emu drums",
    "swiss",
    "mushroom soup",
    "poppy seed",
    "chicken soup",
    "beef succotash",
    "beef sweet potato",
    "babassu oil",
    "corn peas",
    "cumin",
    "feta",
    "butterfinger bar",
    "protein",
    "shrimp fried rice",
    "tuscan",
    "puff",
    "bars",
    "coriander",
    "beef franks",
    "salad dressing onions",
    "fennel",
    "muffins pork",
    "muffins peanut butter",
    "muffins ham spread",
    "orange",
]


class FoundCategories(BaseModel):
    categories: list[str]


image_path = "test-image.jpg"
# ["pineapple", "watermelon", "apple", "kiwifruit", "peaches", "mangos"]

with open(image_path, "rb") as f:
    image_data = f.read()
    image_data_b64 = base64.b64encode(image_data).decode("utf-8")

# Prepare the prompt
usda_catories_str = ", ".join(usda_catories)
prompt = f"""
You will be shown an image. Please identify the food items in the image that belong to the following food categories between equal signs
=========
{usda_catories_str}
=========
Only respond with a JSON array of the categories you see in the image from the list provided.
Do not mention any additional categories or food items not in the list.
Your response should be only the JSON array with no additional text as part of the response. Do not return Markdown.
"""
print("Prompt:", prompt)
client = OpenAI()

response = client.beta.chat.completions.parse(
    # TODO We should test both this model and the GPT-4o-mini model
    # https://platform.openai.com/docs/guides/structured-outputs/introduction
    model="gpt-4o-2024-08-06",
    messages=[
        {
            "role": "user",
            "content": [
                {"type": "text", "text": prompt},
                {
                    "type": "image_url",
                    "image_url": {
                        "url": f"data:{'image/jpeg'};base64,{image_data_b64}"
                    },
                },
            ],
        }
    ],
    response_format=FoundCategories,
)

response_message = response.choices[0].message.content

try:
    categories_found = json.loads(response_message)["categories"]
    print("Categories found in the image:", categories_found)
    missing_categories = [
        category for category in categories_found if category not in usda_catories
    ]
    if missing_categories:
        print(
            f"Warning: The following categories are not in the USDA categories list: {missing_categories}"
        )
except json.JSONDecodeError:
    print(f"actual response: {response_message}")
    print("Failed to parse the assistant's reply as JSON.")
